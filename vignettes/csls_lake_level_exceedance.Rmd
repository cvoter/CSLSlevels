---
title: "CSLS Lake Level Exceedance"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(CSLSlevels)
library(devtools)
library(ggplot2)  # for plotting
library(extrafont)  # for fonts
library(dplyr)  # for %>% pipes
library(reshape2) # for dcast
library(cowplot) # for plotgrid
library(magick) #for drawing images
library(knitr)
library(kableExtra)


csls_levels <- CSLSlevels::csls_levels
lake_names  <- c("Pleasant Lake", "Long Lake", "Plainfield Lake")
probs       <- c(10, 50, 90)
text_size   <- 12

```

## Window of Analysis

This shows how the 10%, 50%, and 90% lake level would change as you change the
start date and/or end date of the window used to calculate the exceedance
curves. My takeaways:

* Lake levels have a steady **increasing trend** over much of the last century.
* Using a longer window of analysis is always better, but using **30 years or more**
should be sufficient.

<br>

**Sensitivity analysis** Here, I'm exploring how long of a window of
analysis is needed in order to reasonably estimate the long term lake level
exceedance curve. I randomly sampled an increasing number of years and
deterimine the 10%, 50%, and 90% exceedance lake levels for each random
permutation. I did this 50 times for each possible window length (from 1 year up to 114
years).

```{r lakelevel04, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 7.5, fig.height = 4.5}
monte_carlo_2018 <- CSLSlevels::monte_carlo_2018
summary_2018     <- summarise_monte_carlo(monte_carlo_2018)
```

```{r lakelevel05, eval=FALSE, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 7.5, fig.height = 4.5}

# Below, I'm showing each monte carlo iteration (grey lines) as well as the **mean
# lake levels** from all permutations (colored lines). While there is quite a bit of
# variation depending on which years are sampled, the random permuations converge
# on a mean lake level as long at least 10 years of data are used.

ggplot() +
  geom_line(data = monte_carlo_2018,
              aes(x = year, y = level), color = "grey70") +
  geom_line(data = summary_2018,
            aes(x = year, y = mean, color = prob)) +
  facet_wrap(~lake, scales = "free_y") +
  scale_color_manual(breaks = as.factor(probs),
                     values = c("#4575B4", "#FDAE61", "#D73027")) +
  theme_bw() +
  theme(text = element_text(family = "Segoe UI Semilight",
                                      size = text_size),
                  plot.title = element_text(hjust = 0.5),
                  panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),
                  legend.position = "top")
```

<br>

Here, I'm showing the **standard deviation** of the 10%, 50%, and 90% lake level
for the 50 permutations of each window. The dashed line marks a window of 38
years. While using more years reduces the variation in estimates of the 10%,
50%, and 90% lake levels, it does appear that there is an inflection point
around 30 years so by using at least 30 years of lake level data,
we should reasonably converge on the long-term behavior. One caveat is that lake
levels are randomly sampled in this analysis and thus are independent from one
another, while real lake levels are pretty strongly autocorrelated with one
another.

```{r lakelevel06, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 7.5, fig.height = 4.5}

# ggplot() +
#   geom_smooth(data = monte_carlo_2018,
#               aes(x = year, y = level, group = prob)) +
#   geom_line(data = summary_2018,
#             aes(x = year, y = mean, color = prob)) +
#   facet_wrap(~lake, scales = "free_y") +
#   scale_color_manual(breaks = as.factor(probs),
#                      values = c("#4575B4", "#FDAE61", "#D73027")) +
#   theme_bw() +
#   theme(text = element_text(family = "Segoe UI Semilight",
#                                       size = text_size),
#                   plot.title = element_text(hjust = 0.5),
#                   panel.grid.major = element_blank(),
#                   panel.grid.minor = element_blank(),
#                   legend.position = "top")

ggplot() +
  geom_line(data = summary_2018,
            aes(x = year, y = std, color = prob)) +
  geom_vline(xintercept = 38, linetype = "dashed") +
  facet_wrap(~lake, scales = "free_y") +
  scale_color_manual(values = c("#4575B4", "#FDAE61", "#D73027")) +
  labs(x = "Number of Years in Window",
       y = "Standard Deviation of Lake Level",
       color = "Exceedance Probability (%)") +
  theme_bw() +
  theme(text = element_text(family = "Segoe UI Semilight",
                                      size = text_size),
                  plot.title = element_text(hjust = 0.5),
                  panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),
                  legend.position = "top")
```

<br>

**Changing end date.** Here, all windows start at 1905. The x-axis represents
the end date of the window. Anything to the right of 1955 (dashed line) is using
> 30 years of levels.

```{r lakelevel01, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 7.5, fig.height = 4.5}
year_prob_level1 <- find_multiple_levels(csls_levels, 
                                         years = c(1905:2018), 
                                         probs = probs,
                                         types = "forward")

plot_analysis_window(year_prob_level1, 1934, text_size = text_size)
```

<br> 

**Changing start date.** Here, all windows end at 2018. The x-axis represents
the changing start date of the window. Anything to the left of 1989 (dashed
line) is using > 30 years of levels.

```{r lakelevel02, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 7.5, fig.height = 4.5}
year_prob_level2 <- find_multiple_levels(csls_levels, 
                                         years = c(1905:2018), 
                                         probs = probs,
                                         types = "backward")

plot_analysis_window(year_prob_level2, 1989, text_size = text_size)
```

<br> 

**38 year window.** Here, all windows end 38 years after the start date. The
x-axis represents the changing start date of the window. Everything plotted here
includes exactly 38 years of data (the end date is 38 years after the plotted
date on the x-axis). The dashed line represents the window 1981 - 2018 (when
daily PRISM data is available).

```{r lakelevel03, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 7.5, fig.height = 4.5}
year_prob_level3 <- find_multiple_levels(csls_levels, 
                                         years = c(1905:2018), 
                                         probs = probs,
                                         types = "forward", 
                                         windows = 38)

plot_analysis_window(year_prob_level3, 1981, text_size = text_size)
```

## Specific Years

Here, we're comparing the exceedance curves for a few specific end years. Dashed
lines highlight the 10%, 50%, and 90% exceedance probabilities. The biggest
differences are between the pre-1960 (window 1905-1960) and post-1981 (window 1981 - 2018) curves.

```{r curves, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 7.5, fig.height = 4.5}
ranked <- rank_multiple_windows(csls_levels, 
                                years = c(1960, 1960, 1981, 2018), 
                                types = c("forward", "backward", "backward", "forward"))
plot_exceedance_curve(ranked, probs, text_size = text_size)
```

<br>

Here are the differences in lake levels (m) between the 10%, 50%, and 90% lake
levels if we used the entire time series (1905-2018) vs. using only the dates 
that overlap with PRISM data (1981-2018).

```{r diff, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
year1 <- 2018
year2 <- 1981

levels1     <- year_prob_level1 %>%
               filter(.data$year == year1) %>%
               select(prob, lake, level)
levels2     <- year_prob_level2 %>%
               filter(.data$year == year2) %>%
               select(prob, lake, level)
levels      <- merge(levels1, levels2, by = c("prob", "lake"))
levels$diff <- levels$level.y - levels$level.x
table       <- dcast(subset(levels, select = c("prob", "lake", "diff")), 
                     prob ~ lake)

probnames       <- sprintf("%s%%", as.character(table$prob))
rownames(table) <- probnames
table           <- table[,-1]
table           <- round(table, digits = 2)

kable(table) %>% kable_styling(bootstrap_options = "striped", full_width = F)
```

<br>

In terms of area, here's what that difference looks like for each of the lakes:

#### Pleasant Lake 
**Left:** 1905-2018 vs. **Right:** 1981-2018
```{r schematic1, eval=TRUE, echo=FALSE, fig.align="center", fig.width = 7.5, fig.height = 4.5}
p1 <- ggdraw() + draw_image("psnt_2018.png")
p2 <- ggdraw() + draw_image("psnt_1981.png")

plot_grid(p1, p2)
```

#### Long Lake 
**Left:** 1905-2018 vs. **Right:** 1981-2018
```{r schematic2, eval=TRUE, echo=FALSE, fig.align="center", fig.width = 7.5, fig.height = 4.5}
p1 <- ggdraw() + draw_image("long_2018.png")
p2 <- ggdraw() + draw_image("long_1981.png")

plot_grid(p1, p2)
```

#### Plainfield Lake 
**Left:** 1905-2018 vs. **Right:** 1981-2018
```{r schematic3, eval=TRUE, echo=FALSE, fig.align="center", fig.width = 7.5, fig.height = 4.5}
p1 <- ggdraw() + draw_image("pfl_2018.png")
p2 <- ggdraw() + draw_image("pfl_1981.png")

plot_grid(p1, p2)
```
