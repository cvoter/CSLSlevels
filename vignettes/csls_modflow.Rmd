---
title: "CSLS Lake Metrics: Estimated Historical vs. MODFLOW"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{CSLS Modflow}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---
Dummy text just because?

```{r setup, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
library(CSLSlevels)
library(dplyr)
library(reshape2)
library(ggplot2)
library(RColorBrewer)
library(extrafont)
library(lubridate)
library(NISTunits)
library(stringr)
library(reshape2)

text_size        <- 12
fig_width        <- 6.5 #12
fig_height       <- 3 # 4

lakes           <- c("Pleasant", "Long", "Plainfield")
csls_levels     <- CSLSlevels::csls_levels
csls_levels_all <- csls_levels %>%
                   filter(.data$lake %in% lakes)
csls_levels     <- csls_levels %>%
                   filter(.data$lake %in% lakes,
                          year(.data$date) >= 1981,
                          year(.data$date) <= 2018)
csls_metrics    <- calculate_metrics(csls_levels)
csls_metrics_all <- calculate_metrics(csls_levels_all)

modflow_levels <- CSLSdata::MODFLOW
modflow_levels <- modflow_levels %>% 
                  mutate(level_pred = .data$level_m,
                         level_obs = NA)
modflow_levels$lake  <- factor(modflow_levels$lake,
                               levels = lakes)
modflow_no_irr <- modflow_levels %>% filter(.data$sim_type == "no_irr")
modflow_irr    <- modflow_levels %>% filter(.data$sim_type == "irr")

no_irr_metrics <- calculate_metrics(modflow_no_irr)
irr_metrics    <- calculate_metrics(modflow_irr)
```

```{r calc, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
create_table <- function(df, 
                         metric_name, 
                         variable_breaks, 
                         variable_labels,
                         convert_units = "",
                         round_precision = NA) {
  table_df <- df %>% 
              filter(.data$metric == metric_name) %>%
              select(.data$lake, .data$variable, .data$value)
  
  if (convert_units == "meterTOft") {
    table_df$value <- NISTmeterTOft(table_df$value)
  }
  if (!is.na(round_precision)) {
    table_df$value <- round((1/round_precision)*table_df$value)/(1/round_precision)
  }
  if (variable_breaks == "sort") {
    variable_breaks <- sort(as.numeric(unique(table_df$variable)))
  }
  if (variable_labels == "breaks") {
    variable_labels <- variable_breaks
  } else if (variable_labels == "percent") {
    variable_labels <- sprintf("%d%%", variable_breaks)
  }
  table_df$variable  <- factor(table_df$variable,
                               levels = variable_breaks,
                               labels = variable_labels)

  table_df <- dcast(table_df, lake~variable, value.var = "value")
  colnames(table_df) <- c("Lake", variable_labels)
  
  return(table_df)
}
```

# Lake Levels

## Estimated Historical

```{r levels01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_levels(csls_levels, point_size = 1, convert_units = "meterTOft",
            legend_pos = c(0.1, 0.9), grid_off = FALSE, text_size = text_size)
```

## MODFLOW Irrigation

```{r levels02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_levels(modflow_irr, point_size = 1, convert_units = "meterTOft",
            legend_pos = c(0.1, 0.9), grid_off = FALSE, text_size = text_size)
```

## MODFLOW No Irrigation
```{r levels03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_levels(modflow_no_irr, point_size = 1, convert_units = "meterTOft",
            legend_pos = c(0.1, 0.9), grid_off = FALSE, text_size = text_size)
```

# 1. Magnitude

## Estimated Historical

```{r magnitude_01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_magnitude(csls_levels, text_size = text_size)
```

## MODFLOW Irrigation

```{r magnitude_02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_magnitude(modflow_irr, text_size = text_size)
```

## MODFLOW No Irrigation

```{r magnitude_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_magnitude(modflow_no_irr, text_size = text_size)
```

<br>

## Estimated Historical

```{r median_level_01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
metric_name     <- "median_level"
metric_title    <- "**Median Lake Level (ft)**"
variable_breaks <- "sort"
variable_labels <- c("Annual","Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul",
                    "Aug", "Sep", "Oct", "Nov", "Dec")

table_df <- create_table(csls_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW Irrigation

```{r median_level_02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW No Irrigation

```{r median_level_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(no_irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = metric_title)
```

<br>

## Estimated Historical

```{r cv_level_01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
metric_name     <- "cv_level"
metric_title    <- "**CV of Lake Levels (%)**"
variable_breaks <- "sort"
variable_labels <- c("Annual","Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul",
                    "Aug", "Sep", "Oct", "Nov", "Dec")

table_df <- create_table(csls_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.01)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW Irrigation

```{r cv_level_02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.01)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW No Irrigation

```{r cv_level_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(no_irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.01)

kableExtra::kable(table_df, caption = metric_title)
```

<br>

# 2. Frequency

## Estimated Historical

```{r frequency01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_frequency(csls_levels, probs = c(10, 50, 90), text_size = text_size)
```

## MODFLOW Irrigation

```{r frequency02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_frequency(modflow_irr, probs = c(10, 50, 90), text_size = text_size)
```

## MODFLOW No Irrigation

```{r frequency03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_frequency(modflow_no_irr, probs = c(10, 50, 90), text_size = text_size)
```

<br>

## Estimated Historical

```{r exceedance_level_01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
metric_name     <- "exceedance_level"
metric_title    <- "**Exceedance Probability Lake Levels (ft)**"
variable_breaks <- "sort"
variable_labels <- "percent"

table_df <- create_table(csls_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW Irrigation

```{r exceedance_level_02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW No Irrigation

```{r exceedance_level_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(no_irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

<br>

# 3. Duration

## Estimated Historical

```{r duration01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_duration(csls_levels, 
              probs = c(10, 90), 
              show_median = TRUE, 
              bin_size = 2, 
              text_size = text_size)
```

## MODFLOW Irrigation

```{r duration02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_duration(modflow_irr, 
              probs = c(10, 90), 
              show_median = TRUE, 
              bin_size = 2, 
              text_size = text_size)
```

## MODFLOW No Irrigation

```{r duration03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_duration(modflow_no_irr, 
              probs = c(10, 90), 
              show_median = TRUE, 
              bin_size = 2, 
              text_size = text_size)
```

<br>

## Estimated Historical

```{r median_dur_01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
metric_name     <- "median_dur"
metric_title    <- "**Median Duration (months)**"
variable_breaks <- "sort"
variable_labels <- "percent"

table_df <- create_table(csls_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW Irrigation

```{r median_dur_02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW No Irrigation

```{r median_dur_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(no_irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

<br>

## Estimated Historical

```{r cv_dur_01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
metric_name     <- "cv_dur"
metric_title    <- "**CV of Duration (%)**"
variable_breaks <- "sort"
variable_labels <- "percent"

table_df <- create_table(csls_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 1)

kableExtra::kable(table_df, caption = metric_title)
```

```{r cv_dur_02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 1)

kableExtra::kable(table_df, caption = metric_title)
```

```{r cv_dur_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(no_irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 1)

kableExtra::kable(table_df, caption = metric_title)
```

<br>

# 4. Rate of change

## Estimated Historical

```{r rate_of_change01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_rate_change(csls_levels, text_size = text_size)
```

## MODFLOW Irrigation

```{r rate_of_change02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_rate_change(modflow_irr, text_size = text_size)
```

## MODFLOW No Irrigation

```{r rate_of_change03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_rate_change(modflow_no_irr, text_size = text_size)
```

<br>

## Estimated Historical

```{r median_rise_rate_01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
metric_name     <- "median_rise_rate"
metric_title    <- "**Median Rise Rate (ft/time period)**"
variable_breaks <- "sort"
variable_labels <- "breaks"

table_df <- create_table(csls_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW Irrigation

```{r median_rise_rate_02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW No Irrigation

```{r median_rise_rate_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(no_irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

<br>

## Estimated Historical

```{r cv_rise_rate_01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
metric_name     <- "cv_rise_rate"
metric_title    <- "**CV of Rise Rate (%)**"
variable_breaks <- "sort"
variable_labels <- "breaks"

table_df <- create_table(csls_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW Irrigation

```{r cv_rise_rate_02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW No Irrigation

```{r cv_rise_rate_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(no_irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

<br>

## Estimated Historical

```{r median_fall_rate_01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
metric_name     <- "median_fall_rate"
metric_title    <- "**Median Fall Rate (ft/time period)**"
variable_breaks <- "sort"
variable_labels <- "breaks"

table_df <- create_table(csls_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW Irrigation

```{r median_fall_rate_02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW No Irrigation

```{r median_fall_rate_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(no_irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

<br>

## Estimated Historical

```{r cv_fall_rate_01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
metric_name     <- "cv_fall_rate"
metric_title    <- "**CV of Fall Rate (%)**"
variable_breaks <- "sort"
variable_labels <- "breaks"

table_df <- create_table(csls_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW Irrigation

```{r cv_fall_rate_02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW No Irrigation

```{r cv_fall_rate_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(no_irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

<br>

# 5. Timing

## Estimated Historical

```{r timing01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_df <- csls_metrics %>%
           filter(.data$metric == "exceedance_range") %>%
           mutate(time = str_sub(.data$variable, 1, 1),
                  range = str_sub(.data$variable, 3, -1),
                  value = NISTunits::NISTmeterTOft(.data$value)) %>%
           mutate(range = str_replace(.data$range, "10_90", "10%-90%")) %>%
           mutate(range = str_replace(.data$range, "25_75", "25%-75%")) %>%
           filter(.data$range != "25%-75%") %>%
           select(.data$lake, .data$time, .data$range, .data$value)
plot_df <- dcast(plot_df, lake+range~time, value.var = "value")


ggplot(plot_df) +
  geom_point(aes(x = a, y = m, shape = lake), 
             color = "black",
             size = 2) +
  geom_abline(slope = 1, intercept = 0) +
  labs(x = "Annual Range (ft)",
       y = "Monthly Range (ft)",
       shape = "") +
  theme_bw() +
  theme(text = element_text(family = "Segoe UI Semilight",
                            size = text_size),
        plot.title = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "top")
```

## MODFLOW No Irrigation

```{r timing02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_df <- irr_metrics %>%
           filter(.data$metric == "exceedance_range") %>%
           mutate(time = str_sub(.data$variable, 1, 1),
                  range = str_sub(.data$variable, 3, -1),
                  value = NISTunits::NISTmeterTOft(.data$value)) %>%
           mutate(range = str_replace(.data$range, "10_90", "10%-90%")) %>%
           mutate(range = str_replace(.data$range, "25_75", "25%-75%")) %>%
           filter(.data$range != "25%-75%") %>%
           select(.data$lake, .data$time, .data$range, .data$value)
plot_df <- dcast(plot_df, lake+range~time, value.var = "value")


ggplot(plot_df) +
  geom_point(aes(x = a, y = m, shape = lake), 
             color = "black",
             size = 2) +
  geom_abline(slope = 1, intercept = 0) +
  labs(x = "Annual Range (ft)",
       y = "Monthly Range (ft)",
       shape = "") +
  theme_bw() +
  theme(text = element_text(family = "Segoe UI Semilight",
                            size = text_size),
        plot.title = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "top")
```

## MODFLOW No Irrigation

```{r timing03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
plot_df <- no_irr_metrics %>%
           filter(.data$metric == "exceedance_range") %>%
           mutate(time = str_sub(.data$variable, 1, 1),
                  range = str_sub(.data$variable, 3, -1),
                  value = NISTunits::NISTmeterTOft(.data$value)) %>%
           mutate(range = str_replace(.data$range, "10_90", "10%-90%")) %>%
           mutate(range = str_replace(.data$range, "25_75", "25%-75%")) %>%
           filter(.data$range != "25%-75%") %>%
           select(.data$lake, .data$time, .data$range, .data$value)
plot_df <- dcast(plot_df, lake+range~time, value.var = "value")


ggplot(plot_df) +
  geom_point(aes(x = a, y = m, shape = lake), 
             color = "black",
             size = 2) +
  geom_abline(slope = 1, intercept = 0) +
  labs(x = "Annual Range (ft)",
       y = "Monthly Range (ft)",
       shape = "") +
  theme_bw() +
  theme(text = element_text(family = "Segoe UI Semilight",
                            size = text_size),
        plot.title = element_text(hjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "top")
```

<br>

## Estimated Historical

```{r exceedance_range_01, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
metric_name     <- "exceedance_range"
metric_title    <- "**Exceedance Probability Range (ft)**"
variable_breaks <- c("a_10_90","a_25_75","m_10_90","m_25_75")
variable_labels <- c("Annual 10%-90%", "Annual 25%-75%", 
                     "Monthly 10%-90%", "Monthly 25%-75%")

table_df <- create_table(csls_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW Irrigation

```{r exceedance_range_02, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```

## MODFLOW No Irrigation

```{r exceedance_range_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
table_df <- create_table(no_irr_metrics, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)

kableExtra::kable(table_df, caption = metric_title)
```
