---
title: "CSLS Lake Metrics - Sensitivity Analysis"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Lake Metrics}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(CSLSlevels)
library(dplyr)
library(reshape2)
library(ggplot2)
library(RColorBrewer)
library(extrafont)
library(lubridate)
library(NISTunits)

text_size              <- 12
convert_to_depth       <- TRUE
lakes                  <- c("Pleasant", "Long", "Plainfield")
csls_levels            <- CSLSlevels::csls_levels
csls_levels            <- csls_levels %>%
                          filter((.data$lake %in% lakes &
                                 year(.data$date) >= 1981 &
                                 year(.data$date) <= 2018) |
                                   (.data$lake == "Devils" &
                                 year(.data$date) >= 1981 &
                                 year(.data$date) <= 2001))

# Lake bottoms for CSLS lakes pulled from lake_raster
# Devil's Lake guesstimated based on "lake depth" in Wikipedia, the most reliable
# of sources.
monte_carlo_metrics    <- CSLSlevels::monte_carlo_metrics
if (convert_to_depth){
  lake_bottom <- data.frame(lake = c("Pleasant", "Long", "Plainfield", "Devils"),
                            bottom = c(291.1426, 332.8622, 332.0755,
                                       NISTftTOmeter(964-47)))
  monte_carlo_metrics <- merge(monte_carlo_metrics, 
                               lake_bottom, 
                               by = "lake", 
                               all.x = TRUE)
  monte_carlo_metrics <- monte_carlo_metrics %>%
                         mutate(sim = ifelse(.data$metric %in% c("median_level",
                                                                 "exceedance_level"),
                                             .data$sim - .data$bottom,
                                             .data$sim),
                                obs = ifelse(.data$metric %in% c("median_level",
                                                                 "exceedance_level"),
                                             .data$obs - .data$bottom,
                                             .data$obs))
  monte_carlo_metrics$bottom <- NULL
}

calculate_fit <- function(summary){
  fit <- summary %>%
         group_by(.data$lake, .data$metric, .data$variable, .data$nyear) %>%
         summarise(PBIAS = 100*abs(mean((.data$sim - .data$obs)/.data$obs, 
                                        na.rm = TRUE)),
                   CV = 100*abs(sd(.data$sim, na.rm = TRUE)/
                        mean(.data$sim, na.rm = TRUE)),
                   RMSE = mean(sqrt((.data$obs - .data$sim)^2),
                               na.rm = TRUE)) %>%
         ungroup() %>%
         as.data.frame()
  fit <- melt(fit, id.vars = c("lake", "metric", "variable", "nyear"))
  colnames(fit) <- c("lake", "metric", "variable", "nyear", "fit", "value")
  return(fit)
}

create_table <- function(df, 
                         metric_name, 
                         variable_breaks, 
                         variable_labels,
                         convert_units = "",
                         round_precision = NA,
                         lakes = c("Pleasant", "Long", "Plainfield")) {
  table_df <- df %>% 
              filter(.data$metric == metric_name) %>% 
              mutate(value = round(.data$value, digits = 2))
  if (convert_units == "meterTOft") {
    table_df$value <- NISTmeterTOft(table_df$value)
  }
  if (!is.na(round_precision)) {
    table_df$value <- round((1/round_precision)*table_df$value)/(1/round_precision)
  }
  if (variable_breaks == "sort") {
    variable_breaks <- sort(as.numeric(unique(table_df$variable)))
  }
  if (variable_labels == "breaks") {
    variable_labels <- variable_breaks
  } else if (variable_labels == "percent") {
    variable_labels <- sprintf("%d%%", variable_breaks)
  }
  table_df$variable  <- factor(table_df$variable,
                               levels = variable_breaks,
                               labels = variable_labels)
  table_df$fit <- NULL
  table_df <- dcast(table_df, lake~variable, value.var = "value")
  colnames(table_df) <- c("Lake", variable_labels)
  
  return(table_df)
}

```

# Overview
The goal of this exercise is to identify whether a 38 year timeseries is
sufficient to reasonably estimate the "true" hydrologic metrics. The "true"
values are of course unknowable, but we approximate them using metrics
calculated with the complete timeseries of data (1905-2018 for CSLS lakes;
1936-2001 for Devil's Lake). 

For each calculated metric, the **first plot** illustrates the 1) bias, 2)
precision, and 3) accuracy of hydrologic metrics calculated based on 100 random
samples of a continuous timeseries of lake levels at annual increments. The
error measurements displayed here are:

 1. **PBIAS**, or percent bias. Difference between simulated metric and "true"
 long-term metric relative to the long-term metric (units of percent). "Biased" 
 metrics in Kennard were those with mean bias > 30% (most were < 20%).
 2. **CV**, or coefficient of variation. Standard deviation of simulated metric
 relative to the mean of the simulated metric (units of percent). "Imprecise"
 metrics in Kennard were those with mean CV > 30% (most were < 25%).
 3. **RMSE**, or root mean squared error. Difference between simulated metric and
 "true" long-term metric as an absolute value (units are same as the metric, e.g.
 "feet" for median levels, "percent" for CV of levels, "months" for
 median duration).

The **second plot** contains a) box plots of the range of
values calculated in 100 random samples of 38 continuous years of lake levels,
b) a triangle representing the value calculated with the full timeseries, and c)
a square representing the value calculated using data from 1981-2018.

Lastly, **two tables** are displayed. The first shows the difference between
1981-2018 values of metrics vs. 1905-2018 values. The second shows the
difference between the mean value for a 38-year timeseries vs. 1905-2018 values.

<br>

```{r calc, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# Metrics for all simulations with nyears = 38
short_fit <- monte_carlo_metrics %>% 
             filter(.data$nyear == 38) %>%
             group_by(.data$lake, .data$metric, .data$variable) %>%
             summarise(sim = median(.data$sim),
                       obs = mean(.data$obs)) %>%
             mutate(value = .data$sim - .data$obs) %>%
             ungroup() %>%
             as.data.frame() %>%
             select(.data$lake, .data$metric, .data$variable, .data$value)

df_box <- monte_carlo_metrics %>% 
          filter(.data$nyear == 38) %>%
          select(lake = .data$lake,
                 metric = .data$metric,
                 variable = .data$variable,
                 value = .data$sim,
                 nsim = .data$nsim)

# Metrics for 1905-2018
csls_metrics_obs <- monte_carlo_metrics %>%
                    select(.data$lake, .data$metric, .data$variable, .data$obs) %>%
                    unique()
df_point         <- csls_metrics_obs %>%
                    select(lake = .data$lake,
                           metric = .data$metric,
                           variable = .data$variable,
                           value = .data$obs)

# Metrics for all simulations
monte_carlo_metrics <- calculate_fit(monte_carlo_metrics)
monte_carlo_metrics <- monte_carlo_metrics %>%
                       mutate(value = ifelse(.data$metric %in% 
                                                c("median_level",
                                                  "exceedance_level",
                                                  "exceedance_range",
                                                  "median_rise_rate",
                                                  "median_fall_rate") &
                                                .data$fit == "RMSE",
                                              NISTmeterTOft(.data$value),
                                              .data$value))

# Metrics & fit for 1981-2018
csls_metrics <- calculate_metrics(csls_levels)
if (convert_to_depth) {
csls_metrics <- merge(csls_metrics, 
                             lake_bottom, 
                             by = "lake", 
                             all.x = TRUE)
csls_metrics <- csls_metrics %>%
                mutate(value = ifelse(.data$metric %in% c("median_level",
                                                          "exceedance_level"),
                                      .data$value - .data$bottom,
                                      .data$value))
csls_metrics$bottom <- NULL
}
df_point_short   <- csls_metrics
colnames(csls_metrics)[which(colnames(csls_metrics) == "value")] <- "sim"
csls_metrics     <- merge(csls_metrics, 
                          csls_metrics_obs,
                          by = c("lake", "metric", "variable"),
                          all.x = TRUE)
csls_fit         <- csls_metrics %>%
                    group_by(.data$lake, .data$metric, .data$variable) %>%
                    mutate(value = .data$sim - .data$obs) %>%
                    ungroup() %>%
                    as.data.frame() %>%
                    select(.data$lake, .data$metric, .data$variable, .data$value)
```

# Summary of Decisions

 1. **Magnitude:** Ok to use median levels and CV of levels.
 2. **Frequency:** Ok to use exceedance probability levels, but do not use ranges
 3. **Duration:** Must be calculated with entire timeseries
 4. **Rate of Change:** Ok to use all, but focus on monthly and seasonal rates
 (more robust than annual rates).

<br>

# Levels

For reference, here is the monthly record of lake levels at each lake. Note that
hydrologic metrics are calculated using the imputed levels for Pleasant, Long,
and Plainfield lake, but are calculated using the observed levels for Devils
Lake. The range of the y-axes are scaled such that 1 foot is the same on all
subplots.

```{r levels, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=5}
plot_levels(CSLSlevels::csls_levels, point_size = 1, convert_units = "meterTOft")
```

<br>

# Magnitude

## Median levels

**With a timeseries of 38 years,** the mean bias is below 10%, the mean variance
is below 15%, and the mean accuracy of median levels is within 0.5 ft for all
lakes.

**With longer timeseries,** variance and accuracy actually worsen for timeseries
lengths ~45 years to 75 years at Long Lake, while other lakes see a steady, but
not dramatic, improvement in these metrics. Bias is consistently low at all
lakes.

**Decision:** Good to use. All metrics are within acceptable ranges and do not
sharply improve with longer timeseries.

**Implications of using 1981-2018 timeseries:** Median levels from 1981-2018 are
the highest of any 38 year window.

```{r median_level_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "median_level"
metric_title    <- ""
variable_title  <- "Month"
variable_breaks <- "sort"
variable_labels <- c("Annual","Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul",
                    "Aug", "Sep", "Oct", "Nov", "Dec")
variable_colors <- c("#000000", brewer.pal(12, "Paired"))
value_title     <- "Median Level (ft)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 0.5))

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r median_level_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
plot_nyear(df_box, df_point, df_point_short, metric_name, metric_title = "",
           variable_title = "", variable_breaks, variable_labels, value_title,
           convert_units = "meterTOft", rotate_xticks = TRUE)
```

<br>

```{r median_level_03, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(csls_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "1981-2018 Difference (ft)")

table_df <- create_table(short_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "Mean 38 year Difference (ft)")
```

## CV of levels

**With a timeseries of 38 years,** the mean bias is below 20%, the mean variance
is below 30%, and the mean accuracy of below 0.03%. Devil's Lake has noticeably
higher bias and RMSE compared to the Central Sands Lakes, while Pleasant Lake
has noticeably higher variance.

**With longer timeseries,** bias worsens but there is noticeable improvement in
variance at Pleasant Lake. All other metrics at all other lakes either plateau
or gradually decline.

**Decision:** Good to use. All metrics are within an acceptable range and do not
sharply improve with longer timeseries, with the exception of variance at
Pleasant Lake.

**Implications of using 1981-2018 timeseries:** The CV of levels from 1981-2018
nearly identical to the long term CV of levels at Long Lake and Devil's Lake,
but are among the lowest observed CVs at Pleasant and Plainfield.

```{r cv_level_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "cv_level"
metric_title    <- ""
variable_title  <- "Month"
variable_breaks <- "sort"
variable_labels <- c("Annual","Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul",
                    "Aug", "Sep", "Oct", "Nov", "Dec")
variable_colors <- c("#000000", brewer.pal(12, "Paired"))
value_title     <- "CV of Levels (%)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 0.03))
plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r cv_level_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
plot_nyear(df_box, df_point, df_point_short, metric_name, metric_title = "",
           variable_title = "", variable_breaks, variable_labels, value_title,
           convert_units = "", ytick_precision = NA, same_range = FALSE, 
           rotate_xticks = TRUE)
```
<br>

```{r cv_level_03, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(csls_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.01)
kableExtra::kable(table_df, caption = "1981-2018 Difference (%)")

table_df <- create_table(short_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.01)
kableExtra::kable(table_df, caption = "Mean 38 year Difference (%)")
```

<br>

# Frequency

## Exceedance probabilities

**With a timeseries of 38 years,** the mean bias is below 5%, mean variance is
below 15%, and mean accuracy is within 0.5 ft. Mean accuracy is just above 0.5
ft for the 10% exceedance probability at Devil's Lake, but the 10% exceedance
probability level is not noticeably worse from other exceedance proabilities at
other lakes.

**With longer timeseries,** the bias for all lakes and variance at Pleasant Lake
and Devil's Lake plateau with longer timeseries. Variance and accuracy worsen
before improving at Long Lake. All other metrics gradually but steadily improve.

**Decision:** Good to use. All metrics are within the acceptable range and do
not sharply improve with longer timeseries. One exception to this might be 10%
exceedance levels at Devil's Lake.

**Implications of using 1981-2018 timeseries:** Infrequent high levels are
fairly close to their long term values, but median levels and infrequent low
levels are high for Pleasant and Plainfield Lake. At Long Lake, only the middle
exceedance levels (25%, 50%, 75%) are substantially higher than the long term
values. This is likely because there are many observations at Long Lake during
the low period in the mid-2000s.

```{r exceedance_level_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "exceedance_level"
metric_title    <- ""
variable_title  <- "Exceed. Prob"
variable_breaks <- "sort"
variable_labels <- "percent"
variable_colors <- c(brewer.pal(6, "Paired")[2:1],
                     "#000000",
                     brewer.pal(6, "Paired")[5:6])
value_title     <- "Lake Level (ft)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 0.5))

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r exceedance_level_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
plot_nyear(df_box, df_point, df_point_short, metric_name, metric_title = "",
           variable_title = "", variable_breaks, variable_labels, value_title,
           convert_units = "meterTOft")
```
<br>

```{r exceedance_level_03, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=5.5}
table_df <- create_table(csls_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "1981-2018 Difference (ft)")

table_df <- create_table(short_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "Mean 38 year Difference (ft)")
```

## Exceedance probability ranges

**With a timeseries of 38 years,** the mean bias is less than 25%, mean variance
is within 40%, and mean accuracy is within 0.7 ft.

**With longer timeseries,** many metrics noticibly improve, though some (e.g.,
Pleasant Lake bias, Plainfield Lake variance) sorsen before improving and others
plateau until much longer timseries (e.g., accuracy at Pleasant, Long, and
Plainfield).

**Decision:** Do not use. These ranges are not as robust as the levels
themselves and error is generally not within acceptable ranges.

**Implications of using 1981-2018 timeseries:** There is no systematic pattern
in whether ranges are above, below, or close to their long term values, which
may be another reason to not use this metric.

```{r exceedance_range_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "exceedance_range"
metric_title    <- ""
variable_title  <- "Exceed. Prob"
variable_breaks <- c("a_10_90","a_25_75","m_10_90","m_25_75")
variable_labels <- c("Annual 10%-90%", "Annual 25%-75%", 
                     "Monthly 10%-90%", "Monthly 25%-75%")
variable_colors <- c(brewer.pal(4, "Paired"))
value_title     <- "Lake Level Range (ft)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 0.5))

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r exceedance_range_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
plot_nyear(df_box, df_point, df_point_short, metric_name, metric_title = "",
           variable_title = "", variable_breaks, variable_labels, value_title,
           convert_units = "meterTOft", rotate_xticks = TRUE)
```
<br>

```{r exceedance_range_03, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
table_df <- create_table(csls_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "1981-2018 Difference (ft)")

table_df <- create_table(short_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "Mean 38 year Difference (ft)")
```

<br>

# Duration

## Median duration

**With a timeseries of 38 years,** the mean bias is over 100%, mean variance is
over 100% and mean RMSE is as high as 20 months.

**With longer timeseries,** most metrics improve, but none are within acceptable
ranges until very close to the full timeseries.

**Decision:** Median duration must be calculated using the full timeseries.

**Implications of using 1981-2018 timeseries:** It will be difficult to compare
duration from the MODFLOW model results with historical durations.

```{r median_dur_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "median_dur"
metric_title    <- ""
variable_title  <- "Exceed. Prob"
variable_breaks <- "sort"
variable_labels <- "percent"
variable_colors <- c(brewer.pal(6, "Paired")[2:1],
                     brewer.pal(6, "Paired")[5:6])
value_title     <- "Months"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 1))

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r median_dur_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
plot_nyear(df_box, df_point, df_point_short, metric_name, metric_title = "",
           variable_title = "", variable_breaks, variable_labels, value_title,
           convert_units = "", same_range = FALSE)
```
<br>

```{r median_dur_03, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(csls_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "1981-2018 Difference (months)")

table_df <- create_table(short_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "Mean 38 year Difference (months)")
```

## CV of duration

**With a timeseries of 38 years,** the mean bias is within 50%, the mean
variance is within 50%, and the mean accuracy is within 125%.

**With longer timeseries,** most metrics improve, but none are within acceptable
ranges until very close to the full timeseries.

**Decision:** CV of duration must also be calculated using the full timeseries.

**Implications of using 1981-2018 timeseries:** Just as the median duration is
not capture well with short timeseries, the variance in duration is not captured
well by short timeseries. This will also be difficult to evaluate using MODFLOW
model results.

```{r cv_dur_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "cv_dur"
metric_title    <- ""
variable_title  <- "Exceed. Prob"
variable_breaks <- "sort"
variable_labels <- "percent"
variable_colors <- c(brewer.pal(6, "Paired")[2:1],
                     brewer.pal(6, "Paired")[5:6])
value_title     <- "CV of Duration (%)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 20))

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r cv_dur_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
plot_nyear(df_box, df_point, df_point_short, metric_name, metric_title = "",
           variable_title = "", variable_breaks, variable_labels, value_title,
           convert_units = "", same_range = FALSE)
```

```{r cv_dur_03, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(csls_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 1)
kableExtra::kable(table_df, caption = "1981-2018 Difference (%)")

table_df <- create_table(short_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 1)
kableExtra::kable(table_df, caption = "Mean 38 year Difference (%)")
```

<br>

# Rate of change

## Median rise rate

**With a timeseries of 38 years,** the mean bias is within 15%, the mean
variance is within 20%, and the mean accuracy is within 0.1 ft/time period.

**With longer timeseries,** mean bias does not substantially improve, but
variance and accuracy gradually continue to decline.

**Decision:** Ok to use all, but focus on monthly and seasonal rise/fall rates.
Annual rise/fall rate is less robust.

**Implications of using 1981-2018 timeseries:** Rates are quite close (within
0.1 ft/time period) of long term rates, this metric is quite robust.

```{r median_rise_rate_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "median_rise_rate"
metric_title    <- ""
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"
variable_colors <- c(brewer.pal(6, "Paired")[c(1, 3, 5)])
value_title     <- "Rise Rate (ft/time period)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 0.1))

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r median_rise_rate_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
plot_nyear(df_box, df_point, df_point_short, metric_name, metric_title = "",
           variable_title, variable_breaks, variable_labels, value_title,
           convert_units = "meterTOft", same_range = FALSE)
```

```{r median_rise_rate_03, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(csls_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "1981-2018 Difference (ft/time period)")

table_df <- create_table(short_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "Mean 38 year Difference (ft/time period)")
```

## CV of rise rate

**With a timeseries of 38 years,** the mean bias is within 10%, mean variance is
within 15%, and mean RMSE is within 5% for monthly and seasonal rates. Annual
rates are within 10%.

**With longer timeseries,** mean bias does not substantially improve, but
variance and accuracy gradually continue to decline.

**Decision:** Ok to use all, but would be reasonable to only use monthly and
seasonal rates.

**Implications of using 1981-2018 timeseries:** the CV of rise rates are quite a
bit different from the long term values, but there is no clear pattern to these
differences.

```{r cv_rise_rate_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "cv_rise_rate"
metric_title    <- ""
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"
variable_colors <- c(brewer.pal(6, "Paired")[c(1, 3, 5)])
value_title     <- "CV of Rise Rate (%)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 5))

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r cv_rise_rate_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
plot_nyear(df_box, df_point, df_point_short, metric_name, metric_title = "",
           variable_title, variable_breaks, variable_labels, value_title,
           convert_units = "", same_range = FALSE)
```

```{r cv_rise_rate_03, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(csls_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "1981-2018 Difference (%)")

table_df <- create_table(short_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "Mean 38 year Difference (%)")
```

## Median fall rate

Same observations as median rise rate.

```{r median_fall_rate_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "median_fall_rate"
metric_title    <- ""
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"
variable_colors <- c(brewer.pal(6, "Paired")[c(1, 3, 5)])
value_title     <- "Fall Rate (ft/time period)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 0.1))

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r median_fall_rate_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
plot_nyear(df_box, df_point, df_point_short, metric_name, metric_title = "",
           variable_title, variable_breaks, variable_labels, value_title,
           convert_units = "meterTOft", same_range = FALSE)
```

```{r median_fall_rate_03, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(csls_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.01)
kableExtra::kable(table_df, caption = "1981-2018 Difference (ft/time period)")

table_df <- create_table(short_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "meterTOft",
                         round_precision = 0.01)
kableExtra::kable(table_df, caption = "Mean 38 year Difference (ft/time period)")
```

## CV of fall rate

Same observations as CV of rise rate.

```{r cv_fall_rate_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "cv_fall_rate"
metric_title    <- ""
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"
variable_colors <- c(brewer.pal(6, "Paired")[c(1, 3, 5)])
value_title     <- "CV of Fall Rate (%)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 5))

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r cv_fall_rate_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
plot_nyear(df_box, df_point, df_point_short, metric_name, metric_title = "",
           variable_title, variable_breaks, variable_labels, value_title,
           convert_units = "", same_range = FALSE)
```

```{r cv_fall_rate_03, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(csls_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "1981-2018 Difference (%)")

table_df <- create_table(short_fit, metric_name, variable_breaks, 
                         variable_labels, convert_units = "",
                         round_precision = 0.1)
kableExtra::kable(table_df, caption = "Mean 38 year Difference (%)")
```
