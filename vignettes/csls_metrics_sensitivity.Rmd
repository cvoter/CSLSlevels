---
title: "CSLS Lake Metrics - Sensitivity Analysis"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Lake Metrics}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(CSLSlevels)
library(dplyr)
library(reshape2)
library(ggplot2)
library(extrafont)

lakes                  <- c("Pleasant", "Long", "Plainfield")
monte_carlo_metrics    <- CSLSlevels::monte_carlo_metrics
moving_windows_metrics <- CSLSlevels::moving_windows_metrics
csls_levels            <- CSLSlevels::csls_levels
csls_levels            <- csls_levels %>%
                          filter(.data$lake %in% lakes,
                                 year(.data$date) >= 1981,
                                 year(.data$date) <= 2018)

text_size <- 12

calculate_fit <- function(summary){
  fit <- summary %>%
         group_by(.data$lake, .data$metric, .data$variable, .data$nyear) %>%
         summarise(PBIAS = 100*mean(abs((.data$sim - .data$obs)/.data$obs), 
                                    na.rm = TRUE),
                   CV = 100*abs(sd(.data$sim, na.rm = TRUE)/
                        mean(.data$sim, na.rm = TRUE)),
                   RMSE = mean(sqrt((.data$obs - .data$sim)^2),
                               na.rm = TRUE)) %>%
         ungroup() %>%
         as.data.frame()
  fit <- melt(fit, id.vars = c("lake", "metric", "variable", "nyear"))
  colnames(fit) <- c("lake", "metric", "variable", "nyear", "fit", "value")
  return(fit)
}

```

# Overview
The goal of this exercise is to identify a minimum number of years required to
reasonably estimate the "true" hydrologic metrics. The "true" values are of
course unknowable, but we approximate them using metrics calculated with the
complete timeseries of data (1905-2018 for CSLS lakes; 1936-2001 for Devil's
Lake). These plots illustrate the 1) bias, 2) precision, and 3) accuracy of
hydrologic metrics calculated with a) random subsets of the timeseries or b) a
moving window of the timeseries. The error measurements displayed here are:

 1. **PBIAS**, or percent bias. Difference between simulated metric and "true"
 long-term metric relative to the long-term metric (units of percent).
 2. **CV**, or coefficient of variation. Standard deviation of simulated metric
 relative to the mean of the simulated metric (units of percent).
 3. **RMSE**, or root mean squared error. Difference between simulated metric and
 "true" long-term metric as an absolute value (units are same as the metric, e.g.
 "meters" for median levels, "percent" for CV of levels, "months" for
 median duration).

```{r calc, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
monte_carlo_metrics <- calculate_fit(monte_carlo_metrics)
```

# Magnitude

## Median levels

```{r median_level, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
metric_name     <- "median_level"
metric_title    <- "Median Level"
variable_title  <- "Month"
variable_breaks <- "sort"
variable_labels <- c("Annual","Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul",
                    "Aug", "Sep", "Oct", "Nov", "Dec")

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels)
```

## CV of levels

```{r cv_level, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
metric_name     <- "cv_level"
metric_title    <- "CV Level"
variable_title  <- "Month"
variable_breaks <- "sort"
variable_labels <- c("Annual","Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul",
                    "Aug", "Sep", "Oct", "Nov", "Dec")

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels)
```

# Frequency

## Exceedance probabilities

```{r exceedance_level, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
metric_name     <- "exceedance_level"
metric_title    <- "Exceedance Level"
variable_title  <- "Exceed. Prob"
variable_breaks <- "sort"
variable_labels <- "percent"

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels)
```

## Exceedance probability ranges

```{r exceedance_range, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
metric_name     <- "exceedance_range"
metric_title    <- "Exceedance Range"
variable_title  <- "Exceed. Prob"
variable_breaks <- c("a_10_90","a_25_75","m_10_90","m_25_75")
variable_labels <- c("Annual 10%-90%", "Annual 25%-75%", 
                     "Monthly 10%-90%", "Monthly 25%-75%")

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels)
```

# Duration

## Median duration

```{r median_dur, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
metric_name     <- "median_dur"
metric_title    <- "Median Duration"
variable_title  <- "Exceed. Prob"
variable_breaks <- "sort"
variable_labels <- "percent"

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels)
```

## CV of duration

```{r cv_dur, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
metric_name     <- "cv_dur"
metric_title    <- "CV Duration"
variable_title  <- "Exceed. Prob"
variable_breaks <- "sort"
variable_labels <- "percent"

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels)
```

# Rate of change

## Median rise rate

```{r median_rise_rate, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
metric_name     <- "median_rise_rate"
metric_title    <- "Median Rise Rate"
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels)
```

## CV of rise rate

```{r cv_rise_rate, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
metric_name     <- "cv_rise_rate"
metric_title    <- "CV Rise Rate"
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels)
```

## Median fall rate

```{r median_fall_rate, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
metric_name     <- "median_fall_rate"
metric_title    <- "Median Fall Rate"
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels)
```

## CV of fall rate

```{r cv_fall_rate, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
metric_name     <- "cv_fall_rate"
metric_title    <- "CV Fall Rate"
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"

plot_sensitivity(monte_carlo_metrics, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels)
```
