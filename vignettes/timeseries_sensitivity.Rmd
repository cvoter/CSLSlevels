---
title: "CSLS Lake Metrics - Sensitivity Analysis"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Lake Metrics}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(CSLSlevels)
library(dplyr)
library(reshape2)
library(ggplot2)
library(RColorBrewer)
library(extrafont)
library(lubridate)
library(NISTunits)
library(patchwork)

# Parameters
csls_lakes      <- c("Pleasant", "Long", "Plainfield")
convert_to_ft   <- TRUE
text_size       <- 12

# Data
hist_metrics_short <- CSLSlevels::hist_metrics_short %>%
                      filter(.data$lake != "Devils") %>%
                      group_by(.data$lake, .data$metric, .data$variable) %>%
                      summarise(median = median(.data$value),
                                sd = sd(.data$value)) %>%
                      ungroup()
hist_metrics_long  <- CSLSlevels::hist_metrics_long %>%
                      filter(.data$lake != "Devils") %>%
                      group_by(.data$lake, .data$metric, .data$variable) %>%
                      summarise(median = median(.data$value),
                                sd = sd(.data$value)) %>%
                      ungroup()
hist_metrics_early  <- CSLSlevels::hist_metrics_early %>%
                      filter(.data$lake != "Devils") %>%
                      group_by(.data$lake, .data$metric, .data$variable) %>%
                      summarise(median = median(.data$value),
                                sd = sd(.data$value)) %>%
                      ungroup()

ts_summary       <- CSLSlevels::ts_summary
ts_metrics_short <- CSLSlevels::ts_metrics_short
```

```{r unit_conversions, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
  length_metrics   <- c("median_level", "exceedance_level", "exceedance_range", 
                      "median_rise_rate", "median_fall_rate")
  ts_summary       <- ts_summary %>%
                      mutate(value = ifelse(.data$metric %in% length_metrics &
                                              .data$fit == "RMSE",
                                            NISTmeterTOft(.data$value), .data$value))
  ts_metrics_short <- ts_metrics_short %>%
                      mutate(sim = ifelse(.data$metric %in% length_metrics,
                                            NISTmeterTOft(.data$sim), .data$sim),
                             obs = ifelse(.data$metric %in% length_metrics,
                                            NISTmeterTOft(.data$obs), .data$obs))
  hist_metrics_long <- hist_metrics_long %>%
                       mutate(median = ifelse(.data$metric %in% length_metrics,
                                              NISTmeterTOft(.data$median), .data$median),
                              sd = ifelse(.data$metric %in% length_metrics,
                                          NISTmeterTOft(.data$sd), .data$sd))
  hist_metrics_short <- hist_metrics_short %>%
                        mutate(median = ifelse(.data$metric %in% length_metrics,
                                               NISTmeterTOft(.data$median), .data$median),
                               sd = ifelse(.data$metric %in% length_metrics,
                                           NISTmeterTOft(.data$sd), .data$sd))
  hist_metrics_early <- hist_metrics_early %>%
                        mutate(median = ifelse(.data$metric %in% length_metrics,
                                               NISTmeterTOft(.data$median), .data$median),
                               sd = ifelse(.data$metric %in% length_metrics,
                                           NISTmeterTOft(.data$sd), .data$sd))

hist_metrics_diff <- left_join(hist_metrics_long, 
                               hist_metrics_short, 
                               by = c("lake", "metric", "variable")) %>%
                     left_join(hist_metrics_early, 
                               by = c("lake", "metric", "variable")) %>%
                     mutate(early_diff = .data$median - .data$median.x,
                            late_diff = .data$median.y - .data$median.x) %>%
                     select(.data$lake, .data$metric, .data$variable, .data$early_diff,
                            .data$late_diff)

```

```{r tables, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
create_table <- function(df, 
                         metric_name, 
                         variable_breaks, 
                         variable_labels,
                         round_precision = NA,
                         lakes = c("Pleasant", "Long", "Plainfield")) {
  table_df <- df %>% 
              filter(.data$metric == metric_name) %>% 
              mutate(delta_38yr = round(.data$delta_38yr, digits = 2),
                     delta_1981 = round(.data$delta_1981, digits = 2))
  if (!is.na(round_precision)) {
    table_df$delta_38yr <- round((1/round_precision)*table_df$delta_38yr)/(1/round_precision)
    table_df$delta_1981 <- round((1/round_precision)*table_df$delta_1981)/(1/round_precision)
  }
  if (variable_breaks == "sort") {
    variable_breaks <- sort(as.numeric(unique(table_df$variable)))
  }
  if (variable_labels == "breaks") {
    variable_labels <- variable_breaks
  } else if (variable_labels == "percent") {
    variable_labels <- sprintf("%d%%", variable_breaks)
  }
  table_df$variable  <- factor(table_df$variable,
                               levels = variable_breaks,
                               labels = variable_labels)
  table_df$metric <- NULL
  colnames(table_df) <- c("Lake", "Variable", "Median 38-yr", "1981-2018")
  table_df <- melt(table_df, id.vars = c("Lake", "Variable"))
  colnames(table_df) <- c("Lake", "Variable", "ts", "value")
  table_df <- dcast(table_df, Lake~ts+Variable, value.var = "value")
  return(table_df)
}

```

# Overview
The goal of this exercise is to identify whether a 38 year timeseries is
sufficient to reasonably estimate the "true" hydrologic metrics. The "true"
values are of course unknowable, but we approximate them using metrics
calculated with the complete timeseries of data (1938-2019 for CSLS lakes;
1936-2001 for Devil's Lake). 

For each calculated metric, the **first plot** illustrates the 1) bias, 2)
precision, and 3) accuracy of hydrologic metrics calculated based on 100 random
samples of a continuous timeseries of lake levels at annual increments. The
error measurements displayed here are:

 1. **PBIAS**, or percent bias. Difference between simulated metric and "true"
 long-term metric relative to the long-term metric (units of percent). "Biased" 
 metrics in Kennard were those with mean bias > 30% (most were < 20%).
 2. **CV**, or coefficient of variation. Standard deviation of simulated metric
 relative to the mean of the simulated metric (units of percent). "Imprecise"
 metrics in Kennard were those with mean CV > 30% (most were < 25%).
 3. **RMSE**, or root mean squared error. Difference between simulated metric and
 "true" long-term metric as an absolute value (units are same as the metric, e.g.
 "feet" for median levels, "percent" for CV of levels, "months" for
 median duration).

The **second plot** contains a) box plots of the range of
values calculated in 100 random samples of 38 continuous years of lake levels,
b) a triangle representing the value calculated with the full timeseries, and c)
a square representing the value calculated using data from 1981-2018.

Lastly, **a table** is displayed showing the difference between the median
38-year metrics vs. 1938-2019 values as well as 1981-2018 values vs. 1938-2019
values.

<br>

# Magnitude

## Median levels

```{r median_level_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "median_level"
metric_title    <- ""
variable_title  <- "Month"
variable_breaks <- "sort"
ts_summary      <- ts_summary %>%
                   mutate(variable = ifelse(.data$variable == "0", 
                                            "13", .data$variable))
variable_labels <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul",
                    "Aug", "Sep", "Oct", "Nov", "Dec", "Overall")
variable_colors <- c(brewer.pal(12, "Paired"), "#000000")
value_title     <- "Median Level (ft)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 0.5))

plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r median_level_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
variable_labels <- c("Overall", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul",
                    "Aug", "Sep", "Oct", "Nov", "Dec")
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                       variable_breaks, variable_labels, value_title,
                       rotate_xticks = TRUE)
```

<br>

```{r median_level_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 0.1)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (ft)")
```

## CV of levels

```{r cv_level_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "cv_level"
metric_title    <- ""
variable_title  <- "Month"
variable_breaks <- "sort"
variable_labels <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul",
                    "Aug", "Sep", "Oct", "Nov", "Dec", "Overall")
variable_colors <- c(brewer.pal(12, "Paired"), "#000000")
value_title     <- "CV of Levels (%)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 5))
plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r cv_level_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
variable_labels <- c("Overall", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul",
                    "Aug", "Sep", "Oct", "Nov", "Dec")
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                       variable_breaks, variable_labels, value_title,
                       rotate_xticks = TRUE)
```
<br>

```{r cv_level_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 0.01)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (%)")
```

<br>

## Exceedance probabilities

```{r exceedance_level_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "exceedance_level"
metric_title    <- ""
variable_title  <- "Exceed. Prob"
variable_breaks <- "sort"
variable_labels <- "percent"
variable_colors <- c(brewer.pal(6, "Paired")[2:1],
                     "#000000",
                     brewer.pal(6, "Paired")[5:6])
value_title     <- "Lake Level (ft)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 0.5))

plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r exceedance_level_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                       variable_breaks, variable_labels, value_title)
# plot_nyear(ts_metrics_short, hist_metrics_long, hist_metrics_short, metric_name, 
#            metric_title = "", variable_title = "", variable_breaks, 
#            variable_labels, value_title, convert_units = "")
```
<br>

```{r exceedance_level_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=5.5}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 0.1)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (ft)")
```

## Exceedance probability ranges

```{r exceedance_range_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "exceedance_range"
metric_title    <- ""
variable_title  <- "Exceed. Prob"
variable_breaks <- c("a_10_90","a_25_75","m_10_90","m_25_75")
variable_labels <- c("Annual\n10-90%", "Annual\n25-75%", 
                     "Monthly\n10-90%", "Monthly\n25-75%")
variable_colors <- c(brewer.pal(4, "Paired"))
value_title     <- "Lake Level Range (ft)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 0.5))

plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r exceedance_range_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                       variable_breaks, variable_labels, value_title)
# plot_nyear(ts_metrics_short, hist_metrics_long, hist_metrics_short, metric_name, metric_title = "",
#            variable_title = "", variable_breaks, variable_labels, value_title,
#            convert_units = "", rotate_xticks = TRUE)
```
<br>

```{r exceedance_range_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=8, fig.height=6}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 0.1)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (ft)")
```

<br>

# Frequency

## Number of times
```{r num_exceed_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "num_dur_decade"
metric_title    <- ""
variable_title  <- "Exceed. Prob"
variable_breaks <- "sort"
variable_labels <- "percent"
variable_colors <- c(brewer.pal(6, "Paired")[2:1],
                     brewer.pal(6, "Paired")[5:6])
value_title     <- "Times/Decade"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 1))

plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

```{r num_exceed_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                  variable_breaks, variable_labels, value_title)
```

```{r num_exceed_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 0.1)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (months)")
```

## Deviation from Median
```{r dev_median_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "depart_median"
metric_title    <- ""
variable_title  <- "Diff. from Median"
variable_breaks <- c("0.3m", "-0.3m")
variable_labels <- c("+1ft", "-1ft")
variable_colors <- c("#1F78B4", "#E31A1C")
value_title     <- "Probability (%)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 5))

plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

```{r dev_median_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                  variable_breaks, variable_labels, value_title)
```

```{r dev_median_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 0.1)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (%)")
```


# Duration

## Median duration

```{r median_dur_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "median_dur"
metric_title    <- ""
variable_title  <- "Exceed. Prob"
variable_breaks <- "sort"
variable_labels <- "percent"
variable_colors <- c(brewer.pal(6, "Paired")[2:1],
                     brewer.pal(6, "Paired")[5:6])
value_title     <- "Months"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 1))

plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r median_dur_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                       variable_breaks, variable_labels, value_title)
```
<br>

```{r median_dur_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 0.1)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (months)")
```

## CV of duration

```{r cv_dur_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "cv_dur"
metric_title    <- ""
variable_title  <- "Exceed. Prob"
variable_breaks <- "sort"
variable_labels <- "percent"
variable_colors <- c(brewer.pal(6, "Paired")[2:1],
                     brewer.pal(6, "Paired")[5:6])
value_title     <- "CV of Duration (%)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 100))

plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r cv_dur_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                       variable_breaks, variable_labels, value_title)
# plot_nyear(ts_metrics_short, hist_metrics_long, hist_metrics_short, metric_name, 
#            metric_title = "", variable_title = "", variable_breaks, 
#            variable_labels, value_title, convert_units = "", same_range = FALSE)
```

```{r cv_dur_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 1)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (%)")
```

<br>

# Rate of change

## Median rise rate

```{r median_rise_rate_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "median_rise_rate"
metric_title    <- ""
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"
variable_colors <- c(brewer.pal(9, "Paired")[c(1, 9, 5)])
value_title     <- "Rise Rate (ft/time period)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 0.1))

plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r median_rise_rate_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                       variable_breaks, variable_labels, value_title)
# plot_nyear(ts_metrics_short, hist_metrics_long, hist_metrics_short, metric_name, 
#            metric_title = "", variable_title, variable_breaks, variable_labels, 
#            value_title, convert_units = "", same_range = FALSE)
```

```{r median_rise_rate_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 0.1)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (ft/time period)")
```

## CV of rise rate

```{r cv_rise_rate_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "cv_rise_rate"
metric_title    <- ""
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"
variable_colors <- c(brewer.pal(9, "Paired")[c(1, 9, 5)])
value_title     <- "CV of Rise Rate (%)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 10))

plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r cv_rise_rate_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                       variable_breaks, variable_labels, value_title)
# plot_nyear(ts_metrics_short, hist_metrics_long, hist_metrics_short, metric_name, 
#            metric_title = "", variable_title, variable_breaks, variable_labels, 
#            value_title, convert_units = "", same_range = FALSE)
```

```{r cv_rise_rate_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 0.1)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (%)")
```

## Median fall rate

```{r median_fall_rate_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "median_fall_rate"
metric_title    <- ""
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"
variable_colors <- c(brewer.pal(9, "Paired")[c(1, 9, 5)])
value_title     <- "Fall Rate (ft/time period)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 0.1))

plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r median_fall_rate_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                       variable_breaks, variable_labels, value_title)
```

```{r median_fall_rate_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 0.01)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (ft/time period)")
```

## CV of fall rate

```{r cv_fall_rate_01, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
metric_name     <- "cv_fall_rate"
metric_title    <- ""
variable_title  <- "Months"
variable_breaks <- "sort"
variable_labels <- "breaks"
variable_colors <- c(brewer.pal(9, "Paired")[c(1, 9, 5)])
value_title     <- "CV of Fall Rate (%)"
hlines          <- data.frame(fit = c("PBIAS", "CV", "RMSE"),
                              value = c(30, 30, 10))

plot_sensitivity(ts_summary, metric_name, metric_title, variable_title, 
                 variable_breaks, variable_labels, variable_colors, text_size,
                 hlines = hlines)
```

<br>

```{r cv_fall_rate_02, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=3}
plot_short_v_long(hist_metrics_short, hist_metrics_long, hist_metrics_early, metric_name,
                       variable_breaks, variable_labels, value_title)
# plot_nyear(ts_metrics_short, hist_metrics_long, hist_metrics_short, metric_name, 
#            metric_title = "", variable_title, variable_breaks, variable_labels, 
#            value_title, convert_units = "", same_range = FALSE)
```

```{r cv_fall_rate_03, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=6.5, fig.height=6}
table_df <- create_table(hist_metrics_diff, metric_name, variable_breaks, 
                         variable_labels, round_precision = 0.1)
kableExtra::kable(table_df, caption = "Difference from Full Timeseries (%)")
```
